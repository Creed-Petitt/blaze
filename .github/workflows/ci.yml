name: Blaze CI

on:
  push:
    branches: [ main, ci-pipeline, feature/* ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'

jobs:
  unit-tests:
    name: Unit Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ libssl-dev libpq-dev libmariadb-dev pkg-config

    - name: Install Dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install cmake openssl libpq mariadb-connector-c pkg-config
        echo "CMAKE_PREFIX_PATH=$(brew --prefix openssl):$(brew --prefix libpq):$(brew --prefix mariadb-connector-c)" >> $GITHUB_ENV

    - name: Cache Build Dependencies
      uses: actions/cache@v3
      with:
        path: build/_deps
        key: ${{ runner.os }}-build-deps-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-build-deps-

    - name: Build
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build --target blaze_tests -j$(nproc 2>/dev/null || sysctl -n hw.ncpu)

    - name: Run Catch2 Suite
      run: ./build/tests/blaze_tests

  integration-and-fuzz:
    name: Integration & Fuzzing (Ubuntu)
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres
        env:
          POSTGRES_PASSWORD: blaze_secret
        ports: [5432:5432]
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: blaze_secret
          MYSQL_DATABASE: blaze
        ports: [3306:3306]
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ libssl-dev libpq-dev libmariadb-dev pkg-config python3 wrk

    - name: Generate SSL Certs
      run: |
        mkdir -p tests/integration_app/certs
        openssl req -x509 -newkey rsa:4096 -keyout tests/integration_app/certs/key.pem -out tests/integration_app/certs/cert.pem -days 365 -nodes -subj "/CN=localhost"

    - name: Generate Static Test Files
      run: |
        mkdir -p tests/integration_app/public
        echo "<h1>Blaze Static Test</h1>" > tests/integration_app/public/index.html

    - name: Build
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build -j$(nproc)

    - name: Run Integration Server
      run: ./build/tests/integration_app/blaze_integration_app & echo $! > app.pid

    - name: Fuzzing Attack
      run: |
        for i in {1..60}; do curl -s http://127.0.0.1:8080/health && break || echo "Waiting for server..."; sleep 1; done
        python3 tests/integration_app/fuzz.py

    - name: Chaos Load Test (DB Failure)
      run: |
        # Start load test in background
        wrk -t4 -c100 -d10s http://127.0.0.1:8080/users &
        WRK_PID=$!
        
        sleep 3
        echo "!!! CHAOS: STOPPING POSTGRES !!!"
        docker stop $(docker ps -q --filter ancestor=postgres)
        
        sleep 2
        echo "!!! CHAOS: RESTARTING POSTGRES !!!"
        docker start $(docker ps -aq --filter ancestor=postgres)
        
        wait $WRK_PID || echo "Wrk finished"

    - name: Full Benchmark Suite
      run: ./tools/benchmark.sh --ci

  fuzzing-libfuzzer:
    name: Internal Fuzzing (LibFuzzer)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ clang llvm libssl-dev libpq-dev libmariadb-dev pkg-config
        
    - name: Build Fuzzers
      run: |
        cmake -B build -DCMAKE_CXX_COMPILER=clang++ -DBLAZE_BUILD_FUZZERS=ON
        cmake --build build -j$(nproc)
        
    - name: Fuzz URL Decoder
      run: ./build/tests/fuzzers/fuzz_url -max_total_time=60
      
    - name: Fuzz JSON Parser
      run: ./build/tests/fuzzers/fuzz_json -max_total_time=60

  lint:
    name: Static Analysis (Clang-Tidy)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ clang-tidy libssl-dev libpq-dev libmariadb-dev
        
    - name: Configure CMake
      run: cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
      
    - name: Run Clang-Tidy
      run: |
        clang-tidy -p build framework/src/*.cpp framework/src/util/*.cpp framework/src/drivers/*/*.cpp

  sanitizer-pass:
    name: Memory Safety (ASan/UBSan)
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres
        env:
          POSTGRES_PASSWORD: blaze_secret
        ports: [5432:5432]
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: blaze_secret
          MYSQL_DATABASE: blaze
        ports: [3306:3306]
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ libssl-dev libpq-dev libmariadb-dev pkg-config python3 wrk

    - name: Generate SSL Certs
      run: |
        mkdir -p tests/integration_app/certs
        openssl req -x509 -newkey rsa:4096 -keyout tests/integration_app/certs/key.pem -out tests/integration_app/certs/cert.pem -days 365 -nodes -subj "/CN=localhost"

    - name: Build with Sanitizers
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Debug -DBLAZE_ENABLE_SANITIZERS=ON
        cmake --build build -j$(nproc)

    - name: Run Sanitized Unit Tests
      run: ./build/tests/blaze_tests

    - name: Run Sanitized Integration App
      run: ./build/tests/integration_app/blaze_integration_app & echo $! > app.pid

    - name: Fuzzing Attack (ASan)
      run: |
        for i in {1..60}; do curl -s http://127.0.0.1:8080/health && break || echo "Waiting for server..."; sleep 1; done
        python3 tests/integration_app/fuzz.py
        ./tools/benchmark.sh --ci
        kill -SIGINT $(cat app.pid) 2>/dev/null || true
        sleep 2

  thread-safety:
    name: Thread Safety (TSan)
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres
        env:
          POSTGRES_PASSWORD: blaze_secret
        ports: [5432:5432]
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: blaze_secret
          MYSQL_DATABASE: blaze
        ports: [3306:3306]
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ libssl-dev libpq-dev libmariadb-dev pkg-config python3 wrk

    - name: Generate SSL Certs
      run: |
        mkdir -p tests/integration_app/certs
        openssl req -x509 -newkey rsa:4096 -keyout tests/integration_app/certs/key.pem -out tests/integration_app/certs/cert.pem -days 365 -nodes -subj "/CN=localhost"

    - name: Build with TSan
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Debug -DBLAZE_ENABLE_TSAN=ON
        cmake --build build -j$(nproc)

    - name: Run TSan Unit Tests
      run: ./build/tests/blaze_tests

    - name: Run TSan Integration App
      run: TSAN_OPTIONS="suppressions=tools/tsan.supp" ./build/tests/integration_app/blaze_integration_app &

    - name: Fuzzing Attack (TSan)
      run: |
        for i in {1..60}; do curl -s http://127.0.0.1:8080/health && break || echo "Waiting for server..."; sleep 1; done
        python3 tests/integration_app/fuzz.py
        # Use centralized benchmark suite for stress testing
        ./tools/benchmark.sh --ci
